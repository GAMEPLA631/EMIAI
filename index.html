<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMI ULTIMATE - Neural Local Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --secondary: #06b6d4; --bg: #020617; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg);
            background-image: radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                              radial-gradient(circle at 100% 100%, rgba(6, 182, 212, 0.08) 0%, transparent 50%);
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .cyber-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .message-in { animation: msgIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: linear-gradient(var(--primary), var(--secondary)); border-radius: 10px; }
        pre code { border-radius: 16px; background: #0b0f1a !important; border: 1px solid rgba(255, 255, 255, 0.05); }
        .ai-bubble { background: rgba(30, 41, 59, 0.4); border-left: 3px solid var(--primary); }
        .user-bubble { background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%); box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.5); }
        .pulsar { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="text-slate-200 h-screen flex flex-col overflow-hidden cyber-grid">

    <!-- NAVIGATION -->
    <nav class="h-20 flex items-center justify-between px-8 shrink-0 z-40 glass border-b border-white/5">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-[0_0_25px_rgba(99,102,241,0.4)]">
                <i data-lucide="brain-circuit" class="text-white w-7 h-7"></i>
            </div>
            <div>
                <h1 class="font-black text-xl tracking-tighter bg-gradient-to-r from-indigo-300 via-white to-cyan-300 bg-clip-text text-transparent uppercase">EMI ULTIMATE</h1>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full pulsar" id="dbIndicator"></span>
                    <span class="text-[9px] text-slate-400 font-bold tracking-[0.2em] uppercase" id="dbStatusText">Pripojenie k IndexedDB...</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="ttsToggle" onclick="toggleTTS()" class="p-3 hover:bg-white/5 rounded-2xl transition-all text-slate-400">
                <i data-lucide="volume-2" id="ttsIcon"></i>
            </button>
            <div class="w-px h-6 bg-white/10 mx-1"></div>
            <button onclick="clearChat()" class="p-3 hover:bg-rose-500/10 rounded-2xl transition-all text-slate-400 hover:text-rose-400">
                <i data-lucide="trash-2"></i>
            </button>
            <button onclick="toggleSettings()" class="p-3 bg-indigo-600/10 text-indigo-400 hover:bg-indigo-600 hover:text-white rounded-2xl transition-all border border-indigo-500/20">
                <i data-lucide="settings"></i>
            </button>
        </div>
    </nav>

    <!-- CHAT VIEWPORT -->
    <main id="chatContainer" class="flex-1 overflow-y-auto custom-scroll p-6 md:p-12 space-y-10 relative z-10">
        <div id="empty-state" class="flex flex-col items-center justify-center h-full opacity-20 text-center">
            <i data-lucide="cpu" class="w-20 h-20 mb-6 text-indigo-500"></i>
            <h2 class="text-2xl font-black uppercase tracking-[0.4em]">Neural Core Ready</h2>
            <p class="mt-2 text-sm font-medium">Všetky dáta sú ukladané lokálne vo vašom prehliadači.</p>
        </div>
    </main>

    <!-- FILE HUB -->
    <div id="filePreview" class="px-12 py-4 flex gap-4 hidden z-20"></div>

    <!-- INPUT CENTER -->
    <footer class="p-6 md:p-10 z-30">
        <div class="max-w-5xl mx-auto">
            <div id="thinkingOverlay" class="hidden mb-8">
                <div class="flex items-center gap-4 px-8 py-4 bg-slate-900 border border-indigo-500/40 rounded-[2rem] w-fit mx-auto shadow-2xl glass">
                    <div class="relative w-3 h-3">
                        <div class="absolute inset-0 bg-indigo-500 rounded-full animate-ping opacity-75"></div>
                        <div class="relative bg-indigo-500 w-3 h-3 rounded-full"></div>
                    </div>
                    <span id="thinkingStatus" class="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-300">EMI dešifruje neurónovú cestu...</span>
                </div>
            </div>

            <div class="glass rounded-[3rem] p-3 shadow-[0_25px_80px_-20px_rgba(0,0,0,0.6)] relative group transition-all hover:border-indigo-500/40">
                <div class="flex items-end gap-3">
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/*,video/*">
                    <button onclick="document.getElementById('fileInput').click()" class="p-5 text-slate-400 hover:text-white hover:bg-white/5 rounded-[2rem] transition-all">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                    
                    <textarea id="userInput" rows="1" 
                        class="flex-1 bg-transparent border-none py-5 px-3 text-slate-100 placeholder-slate-600 focus:outline-none resize-none max-h-64 custom-scroll text-lg font-medium"
                        placeholder="Zadajte príkaz alebo nahrajte súbor pre EMI..."></textarea>
                    
                    <div class="flex items-center gap-3 pr-3">
                        <button id="micBtn" onclick="toggleSpeech()" class="p-5 text-slate-400 hover:text-indigo-400 rounded-full transition-all">
                            <i data-lucide="mic" id="micIcon" class="w-6 h-6"></i>
                        </button>
                        <button id="sendBtn" onclick="handleSend()" class="p-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[2rem] transition-all shadow-xl shadow-indigo-600/30 disabled:opacity-20">
                            <i data-lucide="sparkles" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex justify-center mt-6 gap-8 opacity-40">
                <span class="text-[8px] font-black uppercase tracking-[0.3em]">IndexedDB Persistent</span>
                <span class="text-[8px] font-black uppercase tracking-[0.3em]">Neural Reasoning Engine</span>
                <span class="text-[8px] font-black uppercase tracking-[0.3em]">Zero Cloud Latency</span>
            </div>
        </div>
    </footer>

    <!-- SETTINGS PANEL -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-2xl z-50 hidden flex items-center justify-center p-6">
        <div class="bg-slate-900/80 border border-white/10 w-full max-w-xl rounded-[3.5rem] shadow-2xl overflow-hidden animate-in zoom-in-95 duration-300">
            <div class="p-12">
                <div class="flex items-center justify-between mb-12">
                    <h3 class="text-2xl font-black flex items-center gap-4 tracking-tighter uppercase">
                        <i data-lucide="command" class="text-indigo-400 w-8 h-8"></i> Systémové Jadro
                    </h3>
                    <button onclick="toggleSettings()" class="w-12 h-12 flex items-center justify-center rounded-full hover:bg-white/5 text-slate-500">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                
                <div class="space-y-10">
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4">Google Gemini API Key</label>
                        <input id="apiKeyInput" type="password" class="w-full bg-slate-950 border border-white/5 rounded-2xl px-6 py-5 text-slate-100 outline-none focus:border-indigo-500/50 transition-all" placeholder="AIzaSy...">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4">Vokálna Syntéza</label>
                        <select id="voiceSelect" class="w-full bg-slate-950 border border-white/5 rounded-2xl px-6 py-5 text-slate-100 outline-none appearance-none cursor-pointer"></select>
                    </div>
                    <div class="p-6 bg-emerald-500/5 border border-emerald-500/20 rounded-3xl flex gap-5">
                        <i data-lucide="database" class="text-emerald-500 shrink-0 w-6 h-6"></i>
                        <p class="text-xs text-slate-400 leading-relaxed font-medium">
                            Dáta sú ukladané lokálne cez <strong>IndexedDB</strong>. Toto úložisko je bezpečné, súkromné a neobmedzené až do kapacity vášho disku.
                        </p>
                    </div>
                </div>

                <div class="mt-12 flex gap-4">
                    <button onclick="toggleSettings()" class="flex-1 py-5 bg-slate-800 rounded-3xl font-black text-[10px] uppercase tracking-widest">Zrušiť</button>
                    <button onclick="saveSettings()" class="flex-1 py-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-3xl font-black text-[10px] uppercase tracking-widest shadow-2xl shadow-indigo-600/30 transition-all">Synchronizovať</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        window.state = {
            apiKey: localStorage.getItem('emi_key') || '',
            isThinking: false,
            isRecording: false,
            isTTSActive: localStorage.getItem('emi_tts') === 'true',
            attachments: []
        };

        // --- GLOBAL UTILITIES ---
        window.loadVoices = () => {
            const select = document.getElementById('voiceSelect');
            if (!select) return;
            const voices = speechSynthesis.getVoices();
            select.innerHTML = voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
        };
        speechSynthesis.onvoiceschanged = window.loadVoices;

        window.showToast = (text) => {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-32 left-1/2 -translate-x-1/2 bg-slate-900 border border-indigo-500/50 px-8 py-4 rounded-[2rem] shadow-2xl z-50 animate-in slide-in-from-bottom-5 glass';
            toast.innerHTML = `<p class="text-[10px] font-black uppercase tracking-widest text-indigo-300 flex items-center gap-3"><i data-lucide="info" class="w-4 h-4"></i> ${text}</p>`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 4000);
        };

        // --- DATABASE OPS ---
        let db;
        const dbRequest = indexedDB.open("EmiUltimateDB", 5); // Version 5
        
        dbRequest.onupgradeneeded = (e) => {
            const upgradeDb = e.target.result;
            if (!upgradeDb.objectStoreNames.contains("messages")) {
                upgradeDb.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
            }
        };

        dbRequest.onsuccess = (e) => {
            db = e.target.result;
            document.getElementById('dbIndicator').classList.remove('bg-emerald-500');
            document.getElementById('dbIndicator').classList.add('bg-cyan-400');
            document.getElementById('dbStatusText').innerText = "Lokálna Pamäť Synchronizovaná";
            loadMessagesFromDB();
        };

        dbRequest.onerror = (e) => {
            console.error("Database Error:", e.target.error);
            window.showToast("CHYBA DATABÁZY: Dáta sa neukladajú.");
        };

        function saveToDB(message) {
            if (!db) {
                console.warn("DB not ready, queueing message...");
                setTimeout(() => saveToDB(message), 500);
                return;
            }
            try {
                const tx = db.transaction("messages", "readwrite");
                const store = tx.objectStore("messages");
                store.add(message);
            } catch (err) {
                console.error("Critical Save Error:", err);
                window.showToast("Nepodarilo sa uložiť správu do DB.");
            }
        }

        function loadMessagesFromDB() {
            if (!db) return;
            const tx = db.transaction("messages", "readonly");
            const store = tx.objectStore("messages");
            store.getAll().onsuccess = (e) => {
                const messages = e.target.result;
                if (messages.length > 0) {
                    document.getElementById('empty-state').classList.add('hidden');
                    messages.forEach(window.appendMessageUI);
                }
            };
        }

        window.clearChat = () => {
            if(!confirm("ELIMINOVAŤ DÁTA? Táto akcia natrvalo vymaže celú lokálnu históriu.")) return;
            if (!db) return;
            const tx = db.transaction("messages", "readwrite");
            tx.objectStore("messages").clear().onsuccess = () => {
                document.getElementById('chatContainer').innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                window.showToast("Lokálna pamäť bola vyčistená.");
            };
        };

        // --- UI FUNCTIONS ---
        window.appendMessageUI = (msg) => {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} message-in`;
            
            const mediaHtml = (msg.media && msg.media.length > 0) ? `<div class="flex flex-wrap gap-4 mb-4">
                ${msg.media.map(m => m.mime.startsWith('image/') ? `<img src="data:${m.mime};base64,${m.base64}" class="max-w-[280px] rounded-2xl border border-white/10 shadow-2xl">` : `<div class="p-4 bg-white/5 border border-white/10 rounded-2xl flex items-center gap-3 text-xs font-bold"><i data-lucide="video"></i> DATA STREAM</div>`).join('')}
            </div>` : '';

            const thinkingHtml = msg.thinking ? `<details class="mb-6 bg-black/40 border border-white/5 rounded-[2rem] overflow-hidden group shadow-inner">
                <summary class="p-5 cursor-pointer flex items-center justify-between text-[10px] font-black uppercase tracking-[0.2em] text-indigo-400">
                    <span class="flex items-center gap-3"><i data-lucide="zap" class="w-4 h-4"></i> Deep Reasoning Node</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition-all"></i>
                </summary>
                <div class="p-6 text-xs text-slate-400 leading-relaxed border-t border-white/5 mono opacity-70">${msg.thinking}</div>
            </details>` : '';

            const sourcesHtml = (msg.sources && msg.sources.length > 0) ? `<div class="mt-6 pt-4 border-t border-white/5 flex flex-wrap gap-3">
                ${msg.sources.map(s => `<a href="${s.uri}" target="_blank" class="text-[9px] bg-indigo-500/10 text-indigo-300 px-4 py-2 rounded-xl border border-indigo-500/20 hover:bg-indigo-500/20 transition-all font-black uppercase">Source: ${s.title || 'Link'}</a>`).join('')}
            </div>` : '';

            div.innerHTML = `
                <div class="max-w-[90%] md:max-w-[80%] flex gap-6 ${msg.role === 'user' ? 'flex-row-reverse' : ''}">
                    <div class="w-12 h-12 rounded-2xl shrink-0 flex items-center justify-center mt-2 ${msg.role === 'user' ? 'bg-indigo-600 shadow-indigo-500/40 shadow-xl' : 'bg-slate-800 border border-white/10 shadow-2xl'}">
                        <i data-lucide="${msg.role === 'user' ? 'user' : 'sparkles'}" class="w-6 h-6 text-white"></i>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="px-8 py-6 rounded-[2.8rem] shadow-2xl ${msg.role === 'user' ? 'user-bubble rounded-tr-none text-white' : 'ai-bubble rounded-tl-none glass text-slate-100'}">
                            ${mediaHtml} ${thinkingHtml}
                            <div class="prose prose-invert prose-sm max-w-none leading-relaxed">${marked.parse(msg.content)}</div>
                            ${sourcesHtml}
                        </div>
                        <div class="text-[9px] text-slate-600 px-6 font-black uppercase tracking-widest opacity-50">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                </div>`;
            container.appendChild(div);
            lucide.createIcons();
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        };

        // --- AI LOGIC ---
        async function fetchWithRetry(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return await res.json();
                    if (res.status === 429) { /* Rate limit */ }
                    else if (res.status !== 200) throw new Error(`HTTP ${res.status}`);
                } catch (err) { if (i === retries - 1) throw err; }
                await new Promise(r => setTimeout(r, delay * Math.pow(2, i)));
            }
        }

        window.callEMI = async (prompt, media) => {
            window.state.isThinking = true;
            const thinkingDiv = document.getElementById('thinkingOverlay');
            thinkingDiv.classList.remove('hidden');
            const status = document.getElementById('thinkingStatus');
            const phases = ["Kvantová analýza...", "Hĺbkové uvažovanie...", "Syntéza vedomostí...", "Kryštalizácia pravdy..."];
            let pIdx = 0;
            const interval = setInterval(() => { status.innerText = phases[pIdx % phases.length]; pIdx++; }, 2500);

            try {
                const parts = [{ text: prompt || "Analyzuj vstupy." }];
                media.forEach(m => parts.push({ inlineData: { mimeType: m.mime, data: m.base64 } }));

                const system = `Si EMI, AI s hlbokým uvažovaním. 
                1. Každú odpoveď ZAČNI blokom <reasoning> (aspoň 4 odstavce analýzy).
                2. Buď multimodálna (pozri si obrázky/videá).
                3. Vždy hovor pravdu. Odpovedaj v slovenčine.
                4. Ak vidíš video, analyzuj ho podrobne.`;

                const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${window.state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        systemInstruction: { parts: [{ text: system }] },
                        tools: [{ google_search: {} }]
                    })
                });

                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "EMI neodpovedá.";
                let thinking = "", content = rawText;
                const match = rawText.match(/<reasoning>([\s\S]*?)<\/reasoning>/);
                if (match) {
                    thinking = match[1].trim();
                    content = rawText.replace(/<reasoning>[\s\S]*?<\/reasoning>/, "").trim();
                }

                const sources = data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({
                    uri: a.web?.uri, title: a.web?.title
                })) || [];

                const botMsg = { role: 'assistant', content, thinking, sources, timestamp: Date.now() };
                saveToDB(botMsg);
                window.appendMessageUI(botMsg);

                if(window.state.isTTSActive) window.speak(content);

            } catch (err) {
                window.showToast("CHYBA JADRA: AI nereaguje. Skontrolujte kľúč.");
                console.error(err);
            } finally {
                clearInterval(interval);
                window.state.isThinking = false;
                thinkingDiv.classList.add('hidden');
            }
        };

        // --- HANDLERS ---
        window.handleSend = async () => {
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            if ((!prompt && window.state.attachments.length === 0) || window.state.isThinking) return;

            if(!window.state.apiKey) {
                window.showToast("Prosím, vložte API kľúč v nastaveniach.");
                return window.toggleSettings();
            }

            const userMsg = { role: 'user', content: prompt, media: [...window.state.attachments], timestamp: Date.now() };
            saveToDB(userMsg);
            window.appendMessageUI(userMsg);
            document.getElementById('empty-state').classList.add('hidden');

            const mediaToSend = [...window.state.attachments];
            input.value = '';
            input.style.height = 'auto';
            window.state.attachments = [];
            window.renderAttachments();
            
            await window.callEMI(prompt, mediaToSend);
        };

        window.toggleSettings = () => {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
            document.getElementById('apiKeyInput').value = window.state.apiKey;
            window.loadVoices(); // Call correctly from window
        };

        window.saveSettings = () => {
            window.state.apiKey = document.getElementById('apiKeyInput').value;
            localStorage.setItem('emi_key', window.state.apiKey);
            window.toggleSettings();
            window.showToast("Konfigurácia jadra uložená.");
        };

        window.toggleTTS = () => {
            window.state.isTTSActive = !window.state.isTTSActive;
            localStorage.setItem('emi_tts', window.state.isTTSActive);
            const icon = document.getElementById('ttsIcon');
            icon.setAttribute('data-lucide', window.state.isTTSActive ? 'volume-2' : 'volume-x');
            document.getElementById('ttsToggle').classList.toggle('bg-indigo-500/20', window.state.isTTSActive);
            lucide.createIcons();
        };

        window.speak = (text) => {
            speechSynthesis.cancel();
            const cleanText = text.replace(/```[\s\S]*?```/g, 'Blok kódu preskočený.').replace(/<[^>]*>/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText.substring(0, 800));
            const select = document.getElementById('voiceSelect');
            if (select) {
                utterance.voice = speechSynthesis.getVoices().find(v => v.name === select.value) || null;
            }
            speechSynthesis.speak(utterance);
        };

        window.toggleSpeech = () => {
            if(!recognition) return window.showToast("Hlasová biometria nie je podporovaná.");
            if(window.state.isRecording) {
                recognition.stop();
                window.state.isRecording = false;
                document.getElementById('micIcon').classList.remove('text-rose-500', 'animate-pulse');
            } else {
                recognition.start();
                window.state.isRecording = true;
                document.getElementById('micIcon').classList.add('text-rose-500', 'animate-pulse');
            }
        };

        // --- FILE HANDLING ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for(let file of files) {
                if (file.size > 15 * 1024 * 1024) {
                    window.showToast("Súbor je príliš veľký (max 15MB).");
                    continue;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const base64 = ev.target.result.split(',')[1];
                    window.state.attachments.push({ id: Date.now() + Math.random(), mime: file.type, base64, name: file.name });
                    window.renderAttachments();
                };
                reader.readAsDataURL(file);
            }
        });

        window.renderAttachments = () => {
            const container = document.getElementById('filePreview');
            if(window.state.attachments.length > 0) {
                container.classList.remove('hidden');
                container.innerHTML = window.state.attachments.map(a => `
                    <div class="bg-slate-900 border border-white/10 p-2 rounded-2xl flex items-center gap-3 glass animate-in zoom-in-90 shadow-xl">
                        ${a.mime.startsWith('image/') ? `<img src="data:${a.mime};base64,${a.base64}" class="w-10 h-10 rounded-xl object-cover">` : `<i data-lucide="video" class="w-5 h-5 text-indigo-400"></i>`}
                        <button onclick="removeAttachment(${a.id})" class="text-rose-500 hover:text-rose-400 font-bold px-2">×</button>
                    </div>
                `).join('');
                lucide.createIcons();
            } else { container.classList.add('hidden'); }
        };

        window.removeAttachment = (id) => {
            window.state.attachments = window.state.attachments.filter(a => a.id !== id);
            window.renderAttachments();
        };

        // Final Init
        lucide.createIcons();
        marked.setOptions({ highlight: (code) => hljs.highlightAuto(code).value, breaks: true });
        const area = document.getElementById('userInput');
        area.addEventListener('input', () => { area.style.height = 'auto'; area.style.height = area.scrollHeight + 'px'; });

    </script>
</body>
</html>


